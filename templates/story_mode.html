<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Story Mode - Pancasila Cerdas</title>

  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    /* ... (Your CSS is perfect, no changes needed) ... */
    :root {
      --bg-dark: #081229;
      --box-dark: #071028;
      --box-light: #2f8fd6;
      --accent: #00ffd6;
      --text: #e8f7ff;
      --border: #05203a;
      --scanline-alpha: 0.04;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Press Start 2P', monospace;
      background: #000;
      overflow: hidden;
    }

    /* background */
    .story-background {
      position: fixed;
      inset: 0;
      background: center/cover no-repeat;
      z-index: 1;
      opacity: 0.5;
      /* --- CHANGED --- Added transition for smooth bg changes */
      transition: background-image 0.5s ease-in-out;
    }

    /* character */
    .character {
      position: absolute;
      bottom: 200px;
      height: 50%;
      z-index: 2;
      opacity: 0.4;
      transition: opacity .25s ease, transform .25s ease, bottom .25s ease;
      image-rendering: pixelated;
    }

    .character.left { left: 5%; }
    .character.right { right: 5%; }

    .character.active {
      opacity: 1;
      bottom: 206px; /* --- CHANGED --- simpler transform */
      /* transform: translateY(-6px) scale(1.02); */
      filter: drop-shadow(0 6px 6px rgba(0,0,0,0.6));
    }


    /* --- ADD THIS NEW RULE --- */
    .character.hidden {
      opacity: 0;
      pointer-events: none; /* Prevents clicking on the invisible character */
    }

    /* textbox */
    .dialogue-wrap {
      position: absolute;
      left: 3%;
      right: 3%;
      bottom: 50px;
      z-index: 4;
      display: flex;
      justify-content: center;
    }

    .dialogue-box {
      width: 100%;
      min-height: 120px;
      background:
        linear-gradient(180deg, rgba(255,255,255,var(--scanline-alpha)) 1px, transparent 1px) 0 0/100% 4px,
        var(--box-dark);
      border: 6px solid var(--border);
      box-shadow:
        6px 6px 0 rgba(0,0,0,0.4),
        inset 3px 3px 0 rgba(255,255,255,0.04);
      padding: 18px 22px;
      color: var(--text);
      box-sizing: border-box;
    }

    .meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .name {
      color: var(--accent);
      font-size: 12px;
    }

    .dialogue-text {
      margin-top: 10px;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
      min-height: 60px;
    }

    .btn {
      background: var(--box-light);
      color: #001520;
      border: 4px solid var(--border);
      padding: 10px 16px;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
      border-radius: 0;
    }

    .btn:hover { filter: brightness(1.1); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* options for quiz */
    .options {
      display: flex;
      flex-direction: column;
      margin-top: 12px;
      gap: 8px;
    }

    .option-btn {
      background: #112a4c;
      color: var(--text);
      border: 3px solid var(--border);
      padding: 10px;
      text-align: left;
      font-size: 12px;
      cursor: pointer;
      transition: 0.2s;
    }

    .option-btn:hover {
      background: #2b67a5;
    }

    .option-btn.correct {
      background: #0c684a;
    }

    .option-btn.wrong {
      background: #842e2e;
    }

    /* --- ADDED --- So you can't click a wrong answer again */
    .option-btn:disabled {
        opacity: 0.7;
    }

    /* ... (your existing .character and .character.active rules) ... */

    

  </style>
</head>
<body>
  <div class="story-background" id="background"></div>

  <img id="char-left" src="" class="character left" alt="Character Left">
  <img id="char-right" src="" class="character right" alt="Character Right">

  <div class="dialogue-wrap">
    <div class="dialogue-box">
      <div class="meta">
        <div class="name" id="char-name"></div>
        <button id="next-btn" class="btn">Next ➜</button>
      </div>
      <div class="dialogue-text" id="dialogue-text">Memuat cerita...</div>
      <div id="options" class="options"></div>
    </div>
  </div>

  <script>
    const background = document.getElementById("background");
    const charLeft = document.getElementById("char-left");
    const charRight = document.getElementById("char-right");
    const nameEl = document.getElementById("char-name");
    const textEl = document.getElementById("dialogue-text");
    const nextBtn = document.getElementById("next-btn");
    const optionsBox = document.getElementById("options");

    let currentSceneData = null;
    let eventIndex = 0;

    // 🔹 1. Main function to load a scene from the server
    function loadScene(url) {
      textEl.textContent = "Memuat...";
      nextBtn.disabled = true;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.story_complete) {
            showStoryEnd("Cerita telah selesai!");
            return;
          }
          if (data.error) {
            showStoryEnd(`Error: ${data.error}`);
            return;
          }

          currentSceneData = data;
          eventIndex = 0;

          // --- 1. THIS PART IS NEW ---
          // It preloads all images so the swap is instant
          if (data.assets.preload_images) {
            data.assets.preload_images.forEach(imgName => {
              const img = new Image();
              img.src = `/static/img/${imgName}`;
            });
          }
          // ------------------------------------

          // Load background
          background.style.backgroundImage = `url('/static/img/${currentSceneData.assets.background}')`;
          
          // --- 2. THIS PART IS THE LIKELY FIX ---
          // Make sure you are using "initial_characters" here
          charLeft.src = `/static/img/${currentSceneData.assets.initial_characters.left}`;
          charRight.src = `/static/img/${currentSceneData.assets.initial_characters.right}`;
          // ----------------------------------------------------

          // Start the first event
          runEvent();
        });
    }

    function setActiveSpeaker(position){
      charLeft.classList.remove("active", "hidden");
      charRight.classList.remove("active", "hidden");

      if(position === "left"){
        charLeft.classList.add("active");
      } 
      else if (position === "right") {
        charRight.classList.add("active");
      } 
      else if (position === "narrator") {
        charLeft.classList.add("hidden");
        charRight.classList.add("hidden");
      }
    }
    
    function showStoryEnd(message) {
      textEl.textContent = `✨ ${message} ✨`;
      nameEl.textContent = "Selesai";
      nextBtn.textContent = "Selesai";
      nextBtn.disabled = true;
      optionsBox.innerHTML = "";
      setActiveSpeaker(null);
    }
    
    function goToNextScene() {
      const nextSceneId = currentSceneData.next_scene;
      
      if (!nextSceneId) {
        showStoryEnd("Cerita telah selesai!");
        return;
      }
      
      textEl.textContent = "Menyimpan progres dan memuat adegan berikutnya...";
      nameEl.textContent = "";
      nextBtn.disabled = true;
      setActiveSpeaker(null);
      
      fetch("/api/story/complete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          finished_scene: currentSceneData.scene_id,
          next_scene: nextSceneId
        })
      })
      .then(res => res.json())
      .then(data => {
        if(data.status === 'success') {
          loadScene("/api/story/current");
        } else {
          showStoryEnd(`Error: ${data.error}`);
        }
      });
    }

    function runEvent(){
      const event = currentSceneData.events[eventIndex];
      optionsBox.innerHTML = ""; 
      nextBtn.disabled = false;  

      if(!event){
        goToNextScene();
        return;
      }

      if(event.type === "dialogue"){
        nameEl.textContent = event.character;
        textEl.textContent = event.text;
        setActiveSpeaker(event.speaker_pos);
      }

      else if(event.type === "question"){
        nameEl.textContent = "❓ Kuiz";
        textEl.textContent = event.text;
        nextBtn.disabled = true; 
        setActiveSpeaker(null);

        event.options.forEach(opt => {
          const btn = document.createElement("button");
          btn.className = "option-btn";
          btn.textContent = opt;

          btn.onclick = () => {
            optionsBox.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            if(opt === event.answer){
              btn.classList.add("correct");
              textEl.textContent = "Benar! " + event.explanation;
              nextBtn.disabled = false;
            } else {
              btn.classList.add("wrong");
              textEl.textContent = "Salah. " + event.explanation + " Silakan coba lagi.";
              
              setTimeout(() => {
                textEl.textContent = event.text;
                optionsBox.querySelectorAll('.option-btn').forEach(b => {
                  b.disabled = false; 
                  b.classList.remove("wrong");
                });
              }, 2000);
            }
          };
          optionsBox.appendChild(btn);
        });
      }
      else if(event.type === "character_swap") {
        if (event.position === "left") {
          charLeft.src = `/static/img/${event.image}`;
        } else if (event.position === "right") {
          charRight.src = `/static/img/${event.image}`;
        }
        
        eventIndex++;
        runEvent();
      }
    }

    // --- (Event Listeners) ---
    nextBtn.addEventListener("click", () => {
      eventIndex++;
      runEvent();
    });

    // --- (Initial Load) ---
    // Start the engine by fetching the user's current scene from the API
    loadScene("/api/story/current");

  </script>
</body>
</html>