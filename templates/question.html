<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Question</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    {% if not show_answer %}
    <script>

        history.pushState(null, null, location.href);
    window.onpopstate = function () {
        history.go(1);
    };
    // Bungkus semua kode kamu di dalam event listener ini
    document.addEventListener('DOMContentLoaded', function() {
        
        // Cek apakah elemen timer ada (hanya ada jika not show_answer)
        const timerElement = document.getElementById('timer');
        if (!timerElement) {
            return; // Hentikan eksekusi jika bukan halaman pertanyaan aktif
        }

        let timeLeft = 30; // Batas waktu 30 detik
        
        // Dapatkan elemen form
        const formElement = document.getElementById('question-form');
        
        function countdown() {
            if (timeLeft <= 0) {
                // Hentikan interval
                clearInterval(timerInterval);
                timerElement.textContent = "Waktu Habis!";
                
                setTimeout(() => {
                    fetch(location.href, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ option: null })
                    })
                    .then(res => res.json())
                    .then(data => {
                        updateLives(data.lives, 3);     // update darah
                        showResultBox(data);            // tampilkan result seperti klik tombol
                    });
                }, 1000); 
                return;
            }

            if (timeLeft <= 10) {
                timerElement.classList.add('low-time');
            }
            
            // Perbarui tampilan timer
            timerElement.textContent = timeLeft;
            
            // Ganti warna saat waktu hampir habis
            if (timeLeft <= 10) {
                timerElement.style.color = '#c53030'; // Merah
            }
            
            timeLeft -= 1;
        }

        const timerInterval = setInterval(countdown, 1000);
        
        // Hentikan timer jika pengguna mengklik tombol apa pun
        document.querySelectorAll('.options button').forEach(button => {
            button.addEventListener('click', () => {
                clearInterval(timerInterval);
            });
        });
    });
    
    </script>
    {% endif %}
    

</head>
<body>
       <img src="{{ url_for('static', filename='img/awan.png') }}" alt="cloud" class="ix-cloud small">
    <img src="{{ url_for('static', filename='img/awan2.png') }}" alt="cloud" class="ix-cloud large">
    <img src="{{ url_for('static', filename='img/awan.png') }}" alt="cloud" class="ix-cloud small">
    <img src="{{ url_for('static', filename='img/awan2.png') }}" alt="cloud" class="ix-cloud large">
    <img src="{{ url_for('static', filename='img/awan.png') }}" alt="cloud" class="ix-cloud small">
    <img src="{{ url_for('static', filename='img/awan.png') }}" alt="cloud" class="ix-cloud small">
    <img src="{{ url_for('static', filename='img/awan.png') }}" alt="cloud" class="ix-cloud small">
    <img src="{{ url_for('static', filename='img/awan.png') }}" alt="cloud" class="ix-cloud small">

<div class="page-wrapper">
    <div class="container">
        {% if show_answer %}
            <h1>Result</h1>
            
            <!-- <div class="lives-display" style="margin-bottom: 1rem;">
                {% for _ in range(lives) %}
                    <img src="{{ url_for('static', filename='img/health.png') }}" alt="Life" style="width: 50px !important; height: 50px !important;">
                {% endfor %}
            </div> -->

            <div class="question-title">{{ question.question }}</div>

            {% if is_correct %}
                <div class="explanation correct">
                    <strong>Correct!</strong><br> Your answer was: <br>{{ user_answer }}
                </div>
            {% else %}
                <div class="explanation incorrect">
                    <strong>Incorrect.<br></strong> You answered: <br><strong>{{ user_answer }}</strong>.
                    <p>The correct answer was:<br><strong>{{ correct_answer }}</strong></p>
                </div>
            {% endif %}

            <div class="game-feedback-box">
                <div class="character-img">
                    <img src="{{ url_for('static', filename='img/karakter.jpg') }}" alt="Character" class="retro-character">
                </div>
                
                <div class="speech-bubble">
                    <p><strong>Iniloh penjelasannya!</strong></p>
                    <p>{{ question.explanation }}</p>
                </div>
            </div>

            <a href="{{ next_url }}" class="btn" style="background-color: #007BFF;">
                {% if not game_over %}
                    Soal Selanjutnya &rarr;
                {% else %}
                    Lihat Hasil Akhir &rarr;
                {% endif %}
            </a>
        
        {% else %} 
            <div class="top-bar">
                <div class="lives-display">
                    {% set max_lives = 3 %}
                    {% for i in range(max_lives) %}
                        {% if i < lives %}
                            <img src="{{ url_for('static', filename='img/health.png') }}" alt="Life">
                        {% else %}
                            <img src="{{ url_for('static', filename='img/HeartStroke.png') }}" alt="Lost Life">
                        {% endif %}
                    {% endfor %}
                </div>

                <div id="timer" class="timer-display">30</div>
            </div>

            <h1>Question {{ question_num }}</h1>
            <div class="question-title">{{ question.question }}</div>
            
            <form class="options" id="question-form">
                {% for option in question.options %}
                    <button type="button" value="{{ option }}">{{ option }}</button>
                {% endfor %}
            </form>

            <div id="answer-box" style="display:none; margin-top:20px;"></div>
        {% endif %}
    </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function () {
    const btns = document.querySelectorAll('#question-form button');
    const answerBox = document.getElementById('answer-box');

    btns.forEach(btn => {
        btn.addEventListener('click', async function () {
            const selected = this.value;

            document.getElementById('question-form').style.display = 'none';

            const response = await fetch(location.href, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ option: selected })
            });

            const data = await response.json();

            fetch("/api/answer-record", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    question_text: data.question || "{{ question.question }}",
                    user_answer: data.user_answer,
                    correct_answer: data.correct_answer,
                    is_correct: data.correct,
                    timestamp: new Date().toISOString()
                })
            });

            answerBox.style.display = 'block';

            answerBox.innerHTML = `
                ${
                    data.correct
                    ? `
                        <div class="explanation correct">
                            <strong>Correct!</strong><br> Your answer was: <br>${data.user_answer}
                        </div>
                    `
                    : `
                        <div class="explanation incorrect">
                            <strong>Incorrect.<br></strong> You answered: <br><strong>${data.user_answer}</strong>.
                            <p>The correct answer was:<br><strong>${data.correct_answer}</strong></p>
                        </div>
                    `
                }

                <div class="game-feedback-box">
                    <div class="character-img">
                        <img src="/static/img/karakter.jpg" alt="Character" class="retro-character">
                    </div>

                    <div class="speech-bubble">
                        <p><strong>Iniloh penjelasannya!</strong></p>
                        <p>${data.explanation}</p>
                    </div>
                </div>

                <a id="next-btn" class="btn" style="background-color:#007BFF; cursor:pointer;">
                    ${data.game_over ? "Lihat Hasil Akhir →" : "Soal Selanjutnya →"}
                </a>
            `;

            const nextBtn = document.getElementById('next-btn');

            nextBtn.addEventListener('click', () => {
                if (data.game_over) {
                    window.location.href = "/results";
                } else {
                    window.location.reload();
                }
            });

            const livesDisplay = document.querySelector('.lives-display');
            livesDisplay.innerHTML = '';

            for (let i = 0; i < data.max_lives; i++) {
                if (i < data.lives) {
                    livesDisplay.innerHTML += `
                        <img class="heart" src="/static/img/health.png" style="width:50px;height:50px;" alt="Life">
                    `;
                } else {
                    livesDisplay.innerHTML += `
                        <img class="heart" src="/static/img/HeartStroke.png" style="width:50px;height:50px;" alt="Lost Life">
                    `;
                }
            }


            // Animasi hati terbakar jika salah
            if (!data.correct) {
                const hearts = document.querySelectorAll('.heart');

                // Hati yang hilang adalah index ke data.lives
                const lostIndex = data.lives;

                if (hearts[lostIndex]) {
                    const target = hearts[lostIndex];

                    // Pakai trik reset biar GIF muncul setiap waktu
                    target.src = "";

                    setTimeout(() => {
                        target.src = "/static/img/HatiTerbakar.gif";
                    }, 50);

                    // Setelah 2.5 detik ubah ke HeartStroke
                    setTimeout(() => {
                        target.src = "/static/img/HeartStroke.png";
                    }, 2500);
                }
            }


            // jika game over, redirect otomatis
            // if (data.game_over) {
            //     setTimeout(() => {
            //         window.location.href = "/results";
            //     }, 1200);
            // } else {
            //     // lanjut soal berikutnya
            //     setTimeout(() => {
            //         window.location.reload();
            //     }, 1300);
            // }
        });
    });
});


function updateLives(lives, max) {
    const livesDisplay = document.querySelector('.lives-display');
    livesDisplay.innerHTML = '';
    for (let i = 0; i < max; i++) {
        if (i < lives) {
            livesDisplay.innerHTML += `<img src="/static/img/health.png">`;
        } else {
            livesDisplay.innerHTML += `<img src="/static/img/HeartStroke.png">`;
        }
    }
}

function showResultBox(data) {
    document.getElementById('question-form').style.display = 'none';
    const answerBox = document.getElementById('answer-box');
    answerBox.style.display = "block";

    answerBox.innerHTML = `
        ${data.correct
            ? `<div class="explanation correct"><strong>Correct!</strong><br>Your answer was:<br>${data.user_answer}</div>`
            : `<div class="explanation incorrect"><strong>Incorrect.</strong><br>You answered:<br>${data.user_answer}<br>
                <p>The correct answer was:<br><strong>${data.correct_answer}</strong></p></div>`
        }

        <div class="game-feedback-box">
            <div class="character-img"><img src="/static/img/karakter.jpg" class="retro-character"></div>
            <div class="speech-bubble">
                <p><strong>Iniloh penjelasannya!</strong></p>
                <p>${data.explanation}</p>
            </div>
        </div>

        <a id="next-btn" class="btn" style="background-color:#007BFF; cursor:pointer;">
            ${data.game_over ? "Lihat Hasil Akhir →" : "Soal Selanjutnya →"}
        </a>
    `;

    document.getElementById('next-btn').onclick = () => {
        if (data.game_over) window.location.href = "/results";
        else window.location.reload();
    };
}

</script>

</body>
</html>